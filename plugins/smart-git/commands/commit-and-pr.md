---
description: "コミットからPR作成まで一括実行"
---

# Commit and PR

コミットとPR作成を一括で実行します。

## 0. 事前チェック

以下のコマンドを実行して環境を確認：

### GitHub CLI の確認

`gh --version` を実行。

**インストールされていない場合**、以下のメッセージを表示して処理を中断：

---

**GitHub CLI (`gh`) がインストールされていません。**

PR作成には GitHub CLI が必要です。以下の方法でインストールしてください：

**macOS (Homebrew):**
```bash
brew install gh
```

**Ubuntu/Debian:**
```bash
sudo apt install gh
```

**Windows (winget):**
```bash
winget install GitHub.cli
```

インストール後、以下で認証を行ってください：
```bash
gh auth login
```

詳細: https://cli.github.com/

---

### 認証状態の確認

`gh auth status` を実行。

**未認証の場合**、以下のメッセージを表示して処理を中断：

---

**GitHub CLI の認証が必要です。**

以下のコマンドで認証してください：
```bash
gh auth login
```

---

## Phase 1: コミット

### 1. 現在の状態を確認

以下のコマンドを並列で実行：
- `git status` で変更ファイルを確認
- `git diff --staged` でステージング済みの変更内容を確認
- `git diff` でステージングされていない変更内容を確認
- `git branch --show-current` で現在のブランチ名を取得

### 2. ブランチ確認

mainブランチで実行された場合はエラー：「mainブランチではPRを作成できません。作業ブランチに切り替えてください。」

### 3. コミットメッセージの生成

取得した情報から、Conventional Commits形式でコミットメッセージを生成：

#### プレフィックスの選択基準

ブランチ名と変更内容から、以下のプレフィックスを適切に選択：

- **feat:** 新機能の追加
  - ブランチ名に `feature/`, `feat/` が含まれる場合
  - 新しいファイルが追加された場合

- **fix:** バグ修正
  - ブランチ名に `fix/`, `bugfix/`, `hotfix/` が含まれる場合
  - 既存の動作を修正する変更の場合

- **refactor:** コードのリファクタリング
  - ブランチ名に `refactor/` が含まれる場合
  - 機能は変わらないがコード構造を改善した場合

- **docs:** ドキュメントのみの変更
- **style:** コードフォーマットの変更
- **test:** テストの追加・修正
- **chore:** ビルドプロセスや補助ツールの変更
- **perf:** パフォーマンス改善

#### メッセージの形式

```
<type>: <subject>
```

- **subject**: 変更内容を簡潔に説明（英語、50文字以内推奨）
- 命令形で記述（例: "add" not "added"）
- 末尾にピリオドは付けない

### 4. ステージング状態の確認と処理

#### ステージングされていない変更がある場合

AskUserQuestion ツールで確認：
- 質問: "これらの変更をステージングしてコミットしますか？"
- 選択肢:
  - "すべてステージングしてコミット" → `git add .` を実行
  - "現在ステージング済みの変更のみコミット" → ステージング済みがあればそのまま、なければエラー
  - "キャンセル" → 処理を中止

### 5. コミット実行

1. 生成したメッセージでコミット実行
2. `git log -1` でコミットが正しく作成されたことを確認

---

## Phase 2: PR作成

### 1. PR情報の取得

以下のコマンドを並列で実行：
- `git log main..HEAD --oneline` でコミット一覧を取得
- `git diff main...HEAD --stat` で変更ファイル一覧を取得
- `git diff main...HEAD` で差分の詳細を取得
- `ls .github/PULL_REQUEST_TEMPLATE.md 2>/dev/null` でテンプレート有無を確認

### 2. PRタイトルの決定

AskUserQuestion ツールで確認：
- 質問：「PRタイトルを入力してください（空欄で自動生成）」

#### ユーザーが入力した場合
そのまま使用

#### 空欄の場合（自動生成）
1. ブランチ名からプレフィックスを除去（`feature/`, `fix/` など）
2. kebab-case を自然な文に変換
3. Claudeに指定された言語で生成

### 3. PR説明文の生成

Claudeに指定された言語で以下の形式で生成：

#### テンプレートがある場合
`.github/PULL_REQUEST_TEMPLATE.md` の形式に従って内容を埋める

#### テンプレートがない場合

```markdown
## 概要

[変更内容のサマリー（差分から自動生成、2-3文で簡潔に）]

## 変更内容

- [主要な変更点を箇条書き]

## コミット一覧

- [コミットメッセージ一覧]

## 変更ファイル

- [ファイル一覧]
```

### 4. ドラフト確認

AskUserQuestion ツールで確認：
- 質問：「ドラフトPRとして作成しますか？」
- 選択肢：
  - 「通常のPRとして作成」
  - 「ドラフトPRとして作成」

### 5. リモートへプッシュ

`git push -u origin <branch>` を実行。

### 6. PR作成

```bash
gh pr create --base main --title "<タイトル>" --body "<説明文>" [--draft]
```

---

## 結果表示

以下の情報を表示：
- コミットハッシュ
- コミットメッセージ
- 作成されたPRのURL
- ドラフト/通常の区別
